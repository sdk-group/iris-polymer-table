<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="etable-cell.html">
<link rel="import" href="etable-cell-register.html">
<link rel="import" href="base-templates.html">

<dom-module id="iris-table">
  <template>
    <style>
      :host {
        display: block;
      }

      #entity-table td {
        white-space: nowrap;
      }
    </style>


    <table id="entity-table">
      <tr>
        <template is="dom-if" if="[[multiselect]]">
          <th>
            <paper-checkbox checked="[[isAllSelected(selected.length)]]" id="select-all" on-change="pickAll"></paper-checkbox>
          </th>
        </template>
        <template id="row" is="dom-repeat" items="[[fieldsModel]]" as="model">
          <th>
            [[model.label]]
          </th>
        </template>
      </tr>
      <template id="table" is="dom-repeat" items="[[data]]" as="row">
        <tr>
          <template is="dom-if" if="[[multiselect]]">
            <td>
              <paper-checkbox checked="[[isSelected(row,selected.length)]]" on-change="toggleSelection"></paper-checkbox>
            </td>
          </template>
          <template id="row" is="dom-repeat" items="[[fieldsModel]]" as="model">
            <td>
              <etable-cell is-editable="[[isEditable]]" data="[[getCelldata(model,row)]]" model="[[field]]"></etable-cell>
            </td>
          </template>
        </tr>
      </template>
    </table>

  </template>
  <script>
    'use strict'

    Polymer({
      is: 'iris-table',
      properties: {
        fieldsModel: {
          type: Object
        },
        multiselect: {
          type: Boolean,
          value: false
        },
        isEditable: {
          type: Boolean,
          value: false
        },
        selected: {
          type: Array,
          notify: true
        },
        data: Object
      },
      isAllSelected(len) {
        return this.data.length == len;
      },
      isSelected(row, selected) {
        return !!~this.selected.indexOf(row);
      },
      pickAll(e) {
        if (e.target.checked) {
          _.forEach(this.data, item => !~this.selected.indexOf(item) && this.push('selected', item))
          return;
        }
        this.set('selected', []);
        this.notifyPath('selected.length', 0);
      },
      getCelldata(model, row) {
        return model.field ? row[model.field] : undefined
      },
      toggleSelection(e) {
        var item = this.$.table.itemForElement(e.target);
        if (!e.target.checked) {
          this.arrayDelete('selected', item);
        } else {
          this.push('selected', item);
        }
      },
      ready() {
        this.counter = 0;
      }
    });
  </script>
</dom-module>
