<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="etable-cell.html">
<link rel="import" href="etable-cell-register.html">
<link rel="import" href="base-templates.html">

<dom-module id="iris-table">
  <template>
    <style>
      :host {
        display: block;
        --paper-checkbox-size: 16px;
      }

      .checkbox {
        width: 30px;
      }

      #entity-table td {
        white-space: nowrap;
      }

      tr {
        border-bottom: 1px solid;
        border-color: var(--mydoc-black-200);
        color: var(--mydoc-black-800);
        height: 48px;
      }

      td,
      th {
        padding: 0 12px;
      }

      tr td {
        font-size: 13px;
      }

      tr th {
        color: var(--mydoc-black-600);
        height: 56px;
        font-size: 12px;
      }

      table {
        width: 100%;
        text-align: center;
        border-collapse: collapse;
      }

      tbody tr:last-of-type {
        border-bottom: none;
      }
    </style>


    <table id="entity-table">
      <tr>
        <template is="dom-if" if="[[multiselect]]">
          <th class="checkbox">
            <paper-checkbox checked="[[isAllSelected(selectedIndex.length,data)]]" id="select-all" on-change="pickAll"></paper-checkbox>
          </th>
        </template>
        <template id="row" is="dom-repeat" items="[[computedModel]]" as="model">
          <th>
            [[model.label]]
          </th>
        </template>
      </tr>
      <template id="table" is="dom-repeat" items="[[data]]" as="row">
        <tr>
          <template is="dom-if" if="[[multiselect]]">
            <td class="checkbox">
              <paper-checkbox checked="[[isSelected(index,selectedIndex.length)]]" on-change="toggleSelection"></paper-checkbox>
            </td>
          </template>
          <template id="row" is="dom-repeat" items="[[computedModel]]" as="model">
            <td>
              <etable-cell is-editable="[[isEditable]]" data="[[getCelldata(model,row)]]" model="[[field]]"></etable-cell>
            </td>
          </template>
        </tr>
      </template>
    </table>

  </template>
  <script>
    'use strict'

    Polymer({
      is: 'iris-table',
      properties: {
        fieldsModel: {
          type: Object
        },
        computedModel: {
          type: Array,
          computed: '_computeFields(fieldsModel)'
        },
        multiselect: {
          type: Boolean,
          value: false
        },
        isEditable: {
          type: Boolean,
          value: false
        },
        selected: {
          type: Array,
          value: [],
          notify: true
        },
        selectionField: String,
        selectedIndex: {
          type: Array,
          value: [],
          notify: true
        },
        data: Object
      },
      _computeFields(fieldsModel) {
        return _.isArray(fieldsModel) ? fieldsModel : _.map(fieldsModel, (label, field) => ({
          field,
          label
        }));
      },
      isAllSelected(len) {
        return this.data.length == len;
      },
      isSelected(index, selected) {
        return !!~this.selectedIndex.indexOf(index);
      },
      pickAll(e) {
        if (e.target.checked) {
          let keys = _.keys(this.data);
          this.set('selectedIndex', _.map(keys, k => parseInt(k)));
          this.set('selected', this.selectionField ? _.map(this.data, this.selectionField) : this.data)

          return;
        }
        this.set('selected', []);
        this.set('selectedIndex', []);
        this.notifyPath('selected.length', 0);
        this.notifyPath('selectedIndex.length', 0);
      },
      getCelldata(model, row) {
        return model.field ? row[model.field] : undefined
      },
      toggleSelection(e) {
        var index = e.model.index;
        var item = this.$.table.itemForElement(e.target);
        if (!e.target.checked) {
          this.arrayDelete('selectedIndex', index);
          this.arrayDelete('selected', this.selectionField ? this.data[index][this.selectionField] : this.data[index]);
        } else {
          this.push('selectedIndex', index);
          this.push('selected', this.selectionField ? this.data[index][this.selectionField] : this.data[index]);
        }
      },
      ready() {
        this.counter = 0;
      }
    });
  </script>
</dom-module>
