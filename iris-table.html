<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="etable-cell.html">
<link rel="import" href="etable-cell-register.html">
<link rel="import" href="base-templates.html">

<dom-module id="iris-table">
  <template>
    <style>
      :host {
        display: block;
      }

      #entity-table td {
        white-space: nowrap;
      }
    </style>
    <array-selector id="selector" items="{{data}}" selected="{{selected}}" multi toggle></array-selector>

    <table id="entity-table">
      <tr>
        <template is="dom-if" if="[[multiselect]]">
          <th>
            <paper-checkbox id="select-all" on-change="pickAll"></paper-checkbox>
          </th>
        </template>
        <template id="row" is="dom-repeat" items="[[fieldsModel]]" as="model">
          <th>
            [[model.label]]
          </th>
        </template>
      </tr>
      <template id="table" is="dom-repeat" items="[[data]]" as="row">
        <tr>
          <template is="dom-if" if="[[multiselect]]">
            <td>
              <paper-checkbox checked="[[isSelected(row,selected.length)]]" on-change="toggleSelection"></paper-checkbox>
            </td>
          </template>
          <template id="row" is="dom-repeat" items="[[fieldsModel]]" as="model">
            <td>
              <etable-cell is-editable="[[isEditable]]" data="[[getCelldata(model,row)]]" model="[[field]]"></etable-cell>
            </td>
          </template>
        </tr>
      </template>
    </table>

  </template>
  <script>
    'use strict'

    Polymer({
      is: 'iris-table',
      properties: {
        fieldsModel: {
          type: Object
        },
        multiselect: {
          type: Boolean,
          value: false
        },
        isEditable: {
          type: Boolean,
          value: false
        },
        selected: {
          type: Array,
          notify: true
        },
        data: Object
      },
      isSelected(row, selected) {
        return !!~this.selected.indexOf(row);
      },
      pickAll() {
        _.forEach(this.data, row => this.$.selector.select(row))
      },
      getCelldata(model, row) {
        return model.field ? row[model.field] : undefined
      },
      toggleSelection(e) {
        var item = this.$.table.itemForElement(e.target);
        console.log(e.target);
        console.log(e.target.checked);
        if (!e.target.checked) {
          this.$.selector.select(item);
        } else {
          // this.$.selector.deselect(item);
          this.arrayDelete('selected', item);
        }
      },
      ready() {
        this.counter = 0;
      }
    });
  </script>
</dom-module>
